<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de Renseignement - AAPPMA Gundershoffen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 50%, #3d7a5a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }
        .header-logo { font-size: 50px; margin-bottom: 10px; }
        .header-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .header-subtitle { font-size: 14px; opacity: 0.9; }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .page-title {
            font-size: 22px;
            color: #1a472a;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8f5e9;
        }
        
        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d5a3d;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e8f5e9;
        }
        .form-section-title:first-of-type { margin-top: 0; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-group.required label::after {
            content: " *";
            color: #c62828;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a3d;
            box-shadow: 0 0 0 3px rgba(45,90,61,0.1);
        }
        .form-group input.prefilled {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }
        
        /* R√®glements */
        .reglement-list { margin-top: 10px; }
        .reglement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .reglement-item.checked {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .reglement-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
        .reglement-icon { font-size: 24px; }
        .reglement-name { flex: 1; font-weight: 600; color: #333; }
        .reglement-read-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: not-allowed;
            transition: all 0.3s;
        }
        .reglement-read-btn:not(:disabled) {
            background: #2d5a3d;
            color: white;
            cursor: pointer;
        }
        .reglement-read-btn:not(:disabled):hover {
            background: #1a472a;
        }
        .reglement-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        .reglement-status.read {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .reglement-status.unread {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Bouton */
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.3s;
        }
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45,90,61,0.3);
        }
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Modal r√®glement */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 18px; }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            font-size: 14px;
            line-height: 1.7;
        }
        .modal-body h3 { color: #1a472a; margin: 20px 0 10px; font-size: 16px; }
        .modal-body ul { margin-left: 20px; margin-bottom: 15px; }
        .modal-body li { margin-bottom: 5px; }
        .modal-body .important { background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800; margin: 15px 0; }
        .modal-body .warning { background: #ffebee; padding: 15px; border-radius: 10px; border-left: 4px solid #f44336; margin: 15px 0; }
        .modal-body .info { background: #e3f2fd; padding: 15px; border-radius: 10px; border-left: 4px solid #2196f3; margin: 15px 0; }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .read-confirm-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .read-confirm-checkbox input { width: 20px; height: 20px; }
        .modal-validate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2d5a3d 0%, #4a8c5c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }
        .modal-validate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            transition: transform 0.3s;
            max-width: 90%;
            text-align: center;
        }
        .alert.visible { transform: translateX(-50%) translateY(0); }
        .alert-success { background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50; }
        .alert-error { background: #ffebee; color: #c62828; border: 2px solid #f44336; }
        .alert-info { background: #e3f2fd; color: #1565c0; border: 2px solid #2196f3; }
        
        /* Success page */
        .success-page {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        .success-page.visible { display: block; }
        .success-icon { font-size: 80px; margin-bottom: 20px; }
        .success-title { font-size: 24px; color: #2e7d32; margin-bottom: 15px; font-weight: 700; }
        .success-message { color: #666; line-height: 1.6; margin-bottom: 25px; }
        .success-btn {
            padding: 15px 30px;
            background: #2d5a3d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading-overlay.visible { display: flex; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #2d5a3d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-weight: 600; color: #333; }
        
        .prefill-notice {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #2e7d32;
            text-align: center;
        }
        
        @media (max-width: 500px) {
            .form-row { grid-template-columns: 1fr; }
            .reglement-item { flex-wrap: wrap; }
            .reglement-read-btn { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">üé£</div>
            <div class="header-title">AAPPMA Gundershoffen</div>
            <div class="header-subtitle">Fiche de Renseignement P√™cheur</div>
        </div>
        
        <div class="card">
            <!-- Formulaire -->
            <div id="formPage">
                <h1 class="page-title">üìã Fiche de Renseignement</h1>
                
                <div id="prefillNotice" class="prefill-notice" style="display:none;">
                    ‚úÖ Votre adresse email a √©t√© pr√©-remplie
                </div>
                
                <form id="ficheForm">
                    <div class="form-section-title">üë§ Informations du p√™cheur</div>
                    <div class="form-group required">
                        <label for="nom">Nom</label>
                        <input type="text" id="nom" required>
                    </div>
                    <div class="form-group required">
                        <label for="prenom">Pr√©nom</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="adresse">Adresse</label>
                        <input type="text" id="adresse" placeholder="12 rue de la Paix" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group required">
                            <label for="codePostal">Code postal</label>
                            <input type="text" id="codePostal" maxlength="5" placeholder="67110" required>
                        </div>
                        <div class="form-group required">
                            <label for="ville">Ville</label>
                            <select id="ville" required disabled>
                                <option value="">Entrez le code postal</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group required">
                        <label for="telephone">T√©l√©phone</label>
                        <input type="tel" id="telephone" placeholder="06 XX XX XX XX" required>
                    </div>
                    <div class="form-group required">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="votre@email.com" required>
                    </div>
                    
                    <div class="form-section-title">üö® Contact d'urgence</div>
                    <div class="form-group required">
                        <label for="urgenceNom">Nom</label>
                        <input type="text" id="urgenceNom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgencePrenom">Pr√©nom</label>
                        <input type="text" id="urgencePrenom" required>
                    </div>
                    <div class="form-group required">
                        <label for="urgenceTel">T√©l√©phone</label>
                        <input type="tel" id="urgenceTel" placeholder="06 XX XX XX XX" required>
                    </div>
                    
                    <div class="form-section-title">üìú R√®glements (obligatoire : cochez et lisez)</div>
                    <div class="reglement-list">
                        <div class="reglement-item" data-reglement="carpodrome">
                            <input type="checkbox" class="reglement-checkbox" id="check-carpodrome">
                            <span class="reglement-icon">üé£</span>
                            <span class="reglement-name">Carpodrome</span>
                            <span class="reglement-status unread" id="status-carpodrome">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="carpodrome" disabled>üìñ Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="hardt">
                            <input type="checkbox" class="reglement-checkbox" id="check-hardt">
                            <span class="reglement-icon">üêü</span>
                            <span class="reglement-name">Hardt</span>
                            <span class="reglement-status unread" id="status-hardt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="hardt" disabled>üìñ Lire</button>
                        </div>
                        <div class="reglement-item" data-reglement="breitmatt">
                            <input type="checkbox" class="reglement-checkbox" id="check-breitmatt">
                            <span class="reglement-icon">üåä</span>
                            <span class="reglement-name">Breitmatt</span>
                            <span class="reglement-status unread" id="status-breitmatt">Non lu</span>
                            <button type="button" class="reglement-read-btn" data-for="breitmatt" disabled>üìñ Lire</button>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                        ‚ö†Ô∏è Vous devez cocher au moins un r√®glement, puis le lire et confirmer la lecture
                    </p>
                    
                    <button type="submit" class="btn-submit" id="submitBtn" disabled>
                        ‚úâÔ∏è Envoyer ma fiche
                    </button>
                </form>
            </div>
            
            <!-- Page de succ√®s -->
            <div id="successPage" class="success-page">
                <div class="success-icon">‚úÖ</div>
                <div class="success-title">Fiche envoy√©e avec succ√®s !</div>
                <div class="success-message">
                    Votre fiche de renseignement a √©t√© enregistr√©e et envoy√©e √† l'AAPPMA Gundershoffen.<br><br>
                    Merci pour votre inscription !
                </div>
                <button class="success-btn" onclick="location.reload()">Nouvelle fiche</button>
            </div>
        </div>
        
        <p style="text-align: center; color: rgba(255,255,255,0.7); margin-top: 20px; font-size: 12px;">
            ¬© 2026 AAPPMA Gundershoffen - www.aappma-gundershoffen.fr
        </p>
    </div>
    
    <!-- Modal R√®glement -->
    <div class="modal-overlay" id="reglementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üìú R√®glement</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <label class="read-confirm-checkbox">
                    <input type="checkbox" id="readConfirmCheckbox">
                    <span>J'ai lu et compris le r√®glement</span>
                </label>
                <button class="modal-validate-btn" id="modalValidateBtn" disabled>‚úÖ Confirmer la lecture</button>
            </div>
        </div>
    </div>
    
    <!-- Alert -->
    <div class="alert" id="alert"></div>
    
    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Envoi en cours...</div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // =============================================
        // CONFIGURATION FIREBASE
        // =============================================
        const firebaseConfig = {
            databaseURL: "https://appli-controleur-gunder-default-rtdb.europe-west1.firebasedatabase.app"
        };
        
        // =============================================
        // INITIALISATION
        // =============================================
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);
        
        // =============================================
        // LECTURE PARAM√àTRES URL (email pr√©-rempli)
        // =============================================
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                email: params.get('email'),
                nom: params.get('nom'),
                prenom: params.get('prenom')
            };
        }
        
        // Pr√©-remplir les champs si param√®tres pr√©sents
        document.addEventListener('DOMContentLoaded', function() {
            const params = getUrlParams();
            
            if (params.email) {
                const emailField = document.getElementById('email');
                emailField.value = params.email;
                emailField.classList.add('prefilled');
                document.getElementById('prefillNotice').style.display = 'block';
            }
            
            if (params.nom) {
                document.getElementById('nom').value = params.nom;
            }
            
            if (params.prenom) {
                document.getElementById('prenom').value = params.prenom;
            }
        });
        
        // =============================================
        // R√àGLEMENTS
        // =============================================
        const reglements = {
            carpodrome: { 
                title: "üé£ R√àGLEMENT - CARPODROME 2026", 
                content: `<h3>üóìÔ∏è P√âRIODES ET HORAIRES D'OUVERTURE</h3><p>Les horaires de p√™che :</p><p><strong>30 minutes avant le lever du soleil ‚Üí 30 minutes apr√®s le coucher</strong></p><ul><li><strong>Sur r√©servation uniquement et 24h √† l'avance</strong></li><li>Du <strong>1er mars au 4 mai</strong> : samedis, dimanches et jours f√©ri√©s</li><li>Du <strong>5 mai au 30 octobre</strong> : tous les jours</li><li>P√™che de <strong>8h √† 19h</strong> - P√©riode de mars √† avril et p√©riode de septembre √† fin octobre</li><li>P√™che de <strong>8h √† 20h</strong> - P√©riode de mai √† fin ao√ªt</li></ul><div class="important">L'AAPPMA peut √† tout moment fermer les √©tangs pour cause d'√©v√©nements ind√©pendants de notre volont√© (manque d'eau, cyanobact√©ries, etc...)</div><h3>üé´ R√âSERVATION ET TARIFS</h3><ul><li>Carte <strong>journali√®re</strong> : <strong>10 ‚Ç¨</strong> - Titulaires de la carte annuelle : <strong>5 ‚Ç¨</strong></li><li>Carte <strong>demi-journ√©e</strong> : <strong>6 ‚Ç¨</strong> - Titulaires de la carte annuelle : <strong>3 ‚Ç¨</strong></li></ul><div class="info"><strong>R√©servation obligatoire 24h avant</strong><br>Via formulaire en ligne<br><strong>www.aappma-gundershoffen.fr</strong></div><h3>üé£ MODALIT√âS DE P√äCHE</h3><ul><li>P√™che <strong>No Kill obligatoire</strong></li><li>Canne au coup uniquement, longueur max : <strong>13 m</strong></li><li><strong>1 ligne par p√™cheur</strong></li><li>Max <strong>2 p√™cheurs par poste</strong></li><li>Hame√ßon sans ardillon, taille max <strong>n¬∞10</strong></li><li><strong>Graines cuites obligatoirement</strong></li></ul><h3>‚õî INTERDICTIONS</h3><ul><li>‚ùå Feux au sol et barbecues</li><li>‚ùå P√™che de nuit</li><li>‚ùå Camping</li><li>‚ùå Baignade, canotage</li><li>‚ùå Graines crues</li><li>‚ùå Hame√ßons avec ardillons</li></ul><h3>üëÆ CONTR√îLES ET SANCTIONS</h3><ul><li>‚ö†Ô∏è 1√®re infraction ‚Üí <strong>avertissement</strong></li><li>üö´ 3 avertissements ‚Üí <strong>bannissement</strong></li></ul>` 
            },
            hardt: { 
                title: "üêü R√àGLEMENT √âTANG DE LA HARDT 2026", 
                content: `<h3>üóìÔ∏è P√âRIODES ET HORAIRES D'OUVERTURE</h3><p><strong>30 minutes avant le lever du soleil ‚Üí 30 minutes apr√®s le coucher</strong></p><ul><li>Du <strong>1er mars au 4 mai</strong> : samedis, dimanches et jours f√©ri√©s</li><li>Du <strong>5 mai au 30 octobre</strong> : tous les jours</li><li>Du <strong>1er novembre au 31 d√©cembre</strong> : samedis, dimanches et jours f√©ri√©s</li><li><strong>P√™che de nuit : 20h ‚Üí 8h (r√©servation obligatoire)</strong></li></ul><h3>üé´ CARTES ET TARIFS</h3><ul><li>Carte <strong>journali√®re</strong> : <strong>10 ‚Ç¨</strong></li><li>Carte <strong>demi-journ√©e</strong> : <strong>6 ‚Ç¨</strong></li><li>Carte <strong>p√™che de nuit</strong> : <strong>10 ‚Ç¨</strong></li></ul><h3>üé£ MODALIT√âS DE P√äCHE</h3><ul><li><strong>P√™che No Kill obligatoire</strong></li><li><strong>2 lignes par p√™cheur</strong></li><li><strong>12 postes carpistes</strong> (n¬∞1 √† 12)</li><li><strong>3 postes p√™che au coup</strong></li><li><strong>Graines cuites obligatoirement</strong></li><li><strong>Circulation interdite apr√®s 22h</strong></li></ul><h3>‚õî INTERDICTIONS</h3><ul><li>‚ùå Bateau amorceur</li><li>‚ùå Sacs de conservation</li><li>‚ùå Graines crues</li><li>‚ùå Hame√ßons avec ardillons</li><li>‚ùå Bas de ligne en tresse</li></ul><h3>üëÆ CONTR√îLES ET SANCTIONS</h3><ul><li>‚ö†Ô∏è 1√®re infraction ‚Üí <strong>avertissement</strong></li><li>üö´ 3 avertissements ‚Üí <strong>bannissement</strong></li></ul>` 
            },
            breitmatt: { 
                title: "üåä R√àGLEMENT √âTANG DU BREITMATT 2026", 
                content: `<h3>üóìÔ∏è P√âRIODES D'OUVERTURE</h3><ul><li>Ouvert selon calendrier AAPPMA</li><li>Consulter le site www.aappma-gundershoffen.fr</li></ul><h3>üé£ R√àGLES G√âN√âRALES</h3><ul><li>Carte de p√™che obligatoire</li><li>Respect des autres p√™cheurs</li><li>Respect de l'environnement</li><li><strong>Graines cuites obligatoirement</strong></li></ul><h3>‚õî INTERDICTIONS</h3><ul><li>‚ùå D√©p√¥t de d√©chets</li><li>‚ùå Feux</li><li>‚ùå Camping sauvage</li><li>‚ùå Graines crues</li><li>‚ùå Hame√ßons avec ardillons</li></ul><h3>üëÆ CONTR√îLES ET SANCTIONS</h3><ul><li>Contr√¥les r√©guliers</li><li>‚ö†Ô∏è 1√®re infraction ‚Üí <strong>avertissement</strong></li><li>üö´ 3 avertissements ‚Üí <strong>bannissement</strong></li></ul>` 
            }
        };
        
        let currentReglement = null;
        const reglementsRead = { carpodrome: false, hardt: false, breitmatt: false };
        
        // =============================================
        // GESTION DES R√àGLEMENTS
        // =============================================
        document.querySelectorAll('.reglement-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                const reglement = this.closest('.reglement-item').dataset.reglement;
                const readBtn = document.querySelector(`.reglement-read-btn[data-for="${reglement}"]`);
                const item = this.closest('.reglement-item');
                
                if (this.checked) {
                    readBtn.disabled = false;
                    item.classList.add('checked');
                } else {
                    readBtn.disabled = true;
                    item.classList.remove('checked');
                    reglementsRead[reglement] = false;
                    updateReglementStatus(reglement);
                }
                updateSubmitButton();
            });
        });
        
        document.querySelectorAll('.reglement-read-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentReglement = this.dataset.for;
                const reg = reglements[currentReglement];
                document.getElementById('modalTitle').textContent = reg.title;
                document.getElementById('modalBody').innerHTML = reg.content;
                document.getElementById('readConfirmCheckbox').checked = false;
                document.getElementById('modalValidateBtn').disabled = true;
                document.getElementById('reglementModal').classList.add('visible');
            });
        });
        
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('reglementModal').classList.remove('visible');
        });
        
        document.getElementById('reglementModal').addEventListener('click', (e) => {
            if (e.target.id === 'reglementModal') {
                document.getElementById('reglementModal').classList.remove('visible');
            }
        });
        
        document.getElementById('readConfirmCheckbox').addEventListener('change', function() {
            document.getElementById('modalValidateBtn').disabled = !this.checked;
        });
        
        document.getElementById('modalValidateBtn').addEventListener('click', () => {
            reglementsRead[currentReglement] = true;
            updateReglementStatus(currentReglement);
            document.getElementById('reglementModal').classList.remove('visible');
            updateSubmitButton();
            showAlert('‚úÖ R√®glement ' + currentReglement.toUpperCase() + ' valid√© !', 'success');
        });
        
        function updateReglementStatus(reglement) {
            const status = document.getElementById('status-' + reglement);
            if (reglementsRead[reglement]) {
                status.textContent = '‚úÖ Lu';
                status.className = 'reglement-status read';
            } else {
                status.textContent = 'Non lu';
                status.className = 'reglement-status unread';
            }
        }
        
        function updateSubmitButton() {
            const checkedReglements = document.querySelectorAll('.reglement-checkbox:checked');
            let allCheckedAreRead = true;
            let atLeastOneChecked = checkedReglements.length > 0;
            
            checkedReglements.forEach(cb => {
                const reglement = cb.closest('.reglement-item').dataset.reglement;
                if (!reglementsRead[reglement]) {
                    allCheckedAreRead = false;
                }
            });
            
            document.getElementById('submitBtn').disabled = !(atLeastOneChecked && allCheckedAreRead);
        }
        
        // =============================================
        // API CODE POSTAL
        // =============================================
        document.getElementById('codePostal').addEventListener('input', async function() {
            const cp = this.value.trim();
            const villeSelect = document.getElementById('ville');
            
            if (cp.length === 5) {
                try {
                    const response = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom`);
                    const data = await response.json();
                    
                    villeSelect.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(ville => {
                            const option = document.createElement('option');
                            option.value = ville.nom;
                            option.textContent = ville.nom;
                            villeSelect.appendChild(option);
                        });
                        villeSelect.disabled = false;
                    } else {
                        villeSelect.innerHTML = '<option value="">Aucune ville trouv√©e</option>';
                        villeSelect.disabled = true;
                    }
                } catch (e) {
                    villeSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                }
            } else {
                villeSelect.innerHTML = '<option value="">Entrez le code postal</option>';
                villeSelect.disabled = true;
            }
        });
        
        // =============================================
        // ENVOI DU FORMULAIRE
        // =============================================
        document.getElementById('ficheForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // R√©cup√©rer les donn√©es
            const nom = document.getElementById('nom').value.toUpperCase().trim();
            const prenom = document.getElementById('prenom').value.trim();
            const adresse = document.getElementById('adresse').value.trim();
            const codePostal = document.getElementById('codePostal').value.trim();
            const ville = document.getElementById('ville').value;
            const telephone = document.getElementById('telephone').value.trim();
            const email = document.getElementById('email').value.trim();
            const urgenceNom = document.getElementById('urgenceNom').value.toUpperCase().trim();
            const urgencePrenom = document.getElementById('urgencePrenom').value.trim();
            const urgenceTel = document.getElementById('urgenceTel').value.trim();
            
            // R√®glements coch√©s et lus
            const reglementsValides = [];
            document.querySelectorAll('.reglement-checkbox:checked').forEach(cb => {
                const reg = cb.closest('.reglement-item').dataset.reglement;
                if (reglementsRead[reg]) {
                    reglementsValides.push(reg.toUpperCase());
                }
            });
            
            const dateInscription = new Date().toLocaleString('fr-FR');
            
            // Afficher le loading
            document.getElementById('loading').classList.add('visible');
            
            try {
                // Enregistrer dans Firebase
                const ficheData = {
                    nom: nom,
                    prenom: prenom,
                    adresse: adresse,
                    codePostal: codePostal,
                    ville: ville,
                    telephone: telephone,
                    email: email,
                    urgence: {
                        nom: urgenceNom,
                        prenom: urgencePrenom,
                        telephone: urgenceTel
                    },
                    reglements: reglementsValides,
                    date: dateInscription,
                    id: Date.now().toString(),
                    source: 'formulaire-public'
                };
                
                await db.ref('fiches').push(ficheData);
                console.log('‚úÖ Fiche enregistr√©e dans Firebase');
                
                // Masquer le loading
                document.getElementById('loading').classList.remove('visible');
                
                // Afficher la page de succ√®s
                document.getElementById('formPage').style.display = 'none';
                document.getElementById('successPage').classList.add('visible');
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').classList.remove('visible');
                showAlert('‚ùå Erreur lors de l\'envoi. Veuillez r√©essayer.', 'error');
            }
        });
        
        // =============================================
        // ALERT
        // =============================================
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type + ' visible';
            setTimeout(() => alert.classList.remove('visible'), 4000);
        }
    </script>
</body>
</html>
